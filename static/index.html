<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>智能安全管理系统</title>
  <!-- 第三方资源 -->
  <link rel="stylesheet" href="https://unpkg.com/element-plus@2.3.9/dist/index.css">
  <script src="https://cdn.jsdelivr.net/npm/vue@3.2.45/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue-router@4.1.6/dist/vue-router.global.prod.js"></script>
  <script src="https://unpkg.com/element-plus@2.3.9/dist/index.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@element-plus/icons-vue@2.0.10/dist/index.global.js"></script>
  <!-- 自定义资源 -->
  <link rel="stylesheet" href="style.css">
  <script src="app.js" defer></script>
</head>
<body>
  <div id="app">
    <el-container style="height: 100vh;">
      <!-- 注册对话框 -->
      <el-dialog v-model="showRegister" title="注册新账户" width="420px">
        <el-form :model="registerForm" :rules="registerRules" class="login-form">
          <el-form-item prop="username">
            <el-input
              v-model="registerForm.username"
              placeholder="请输入用户名"
              prefix-icon="User"
              size="large"
            >
              <template #prefix>
                <el-icon><User /></el-icon>
              </template>
            </el-input>
          </el-form-item>
          <el-form-item prop="password">
            <el-input
              v-model="registerForm.password"
              placeholder="请输入密码"
              type="password"
              prefix-icon="Lock"
              show-password
              size="large"
            >
              <template #prefix>
                <el-icon><Lock /></el-icon>
              </template>
            </el-input>
          </el-form-item>
          <el-form-item prop="confirmPassword">
            <el-input
              v-model="registerForm.confirmPassword"
              placeholder="请确认密码"
              type="password"
              prefix-icon="Lock"
              show-password
              size="large"
            >
              <template #prefix>
                <el-icon><Lock /></el-icon>
              </template>
            </el-input>
          </el-form-item>
          <el-form-item>
            <el-button
              type="primary"
              @click="handleRegister"
              size="large"
              style="width: 100%;"
            >
              注册
            </el-button>
          </el-form-item>
        </el-form>
      </el-dialog>

      <!-- 忘记密码对话框 -->
      <el-dialog v-model="showForgotPassword" title="忘记密码" width="420px">
        <el-form :model="forgotForm" :rules="forgotRules" class="login-form">
          <el-form-item prop="username">
            <el-input
              v-model="forgotForm.username"
              placeholder="请输入用户名"
              prefix-icon="User"
              size="large"
            >
              <template #prefix>
                <el-icon><User /></el-icon>
              </template>
            </el-input>
          </el-form-item>
          <el-form-item prop="newPassword">
            <el-input
              v-model="forgotForm.newPassword"
              placeholder="请输入新密码"
              type="password"
              prefix-icon="Lock"
              show-password
              size="large"
            >
              <template #prefix>
                <el-icon><Lock /></el-icon>
              </template>
            </el-input>
          </el-form-item>
          <el-form-item prop="confirmNewPassword">
            <el-input
              v-model="forgotForm.confirmNewPassword"
              placeholder="请确认新密码"
              type="password"
              prefix-icon="Lock"
              show-password
              size="large"
            >
              <template #prefix>
                <el-icon><Lock /></el-icon>
              </template>
            </el-input>
          </el-form-item>
          <el-form-item>
            <el-button
              type="primary"
              @click="handleForgotPassword"
              size="large"
              style="width: 100%;"
            >
              重置密码
            </el-button>
          </el-form-item>
        </el-form>
      </el-dialog>

      <!-- 登录区域 -->
      <div v-if="!isAuthenticated" class="login-container">
        <div class="login-background">
          <div class="login-shapes">
            <div class="shape shape-1"></div>
            <div class="shape shape-2"></div>
            <div class="shape shape-3"></div>
          </div>
        </div>
        <el-card class="login-card">
          <div class="login-header">
            <div class="login-logo">
              <i class="el-icon-lock"></i>
            </div>
            <h2 class="login-title">智能安全管理系统</h2>
            <p class="login-subtitle">安全 · 智能 · 高效</p>
          </div>
          <el-form :model="loginForm" :rules="loginRules" ref="loginFormRef" class="login-form">
            <el-form-item prop="username">
              <el-input
                v-model="loginForm.username"
                placeholder="请输入用户名"
                prefix-icon="User"
                size="large"
              >
                <template #prefix>
                  <el-icon><User /></el-icon>
                </template>
              </el-input>
            </el-form-item>

            <el-form-item prop="password">
              <el-input
                v-model="loginForm.password"
                placeholder="请输入密码"
                type="password"
                prefix-icon="Lock"
                show-password
                size="large"
                @keyup.enter="handleLogin"
              >
                <template #prefix>
                  <el-icon><Lock /></el-icon>
                </template>
              </el-input>
            </el-form-item>
            <el-form-item>
              <el-button
                type="primary"
                @click="handleLogin"
                size="large"
                style="width: 100%; height: 44px; font-size: 16px;"
              >
                登录
              </el-button>
            </el-form-item>
            <div class="login-footer">
              <el-link type="primary" @click="showRegister = true">注册新账户</el-link>
              <el-link type="info" @click="showForgotPassword = true">忘记密码？</el-link>
            </div>
          </el-form>
        </el-card>
      </div>

      <!-- 主界面 -->
      <div v-else class="main-container">
          <div v-if="false" style="display:none">{{ console.log('主界面渲染') }}</div>
        <el-header class="header">
          <div class="header-left">
            <div class="logo">
              <i class="el-icon-lock"></i>
            </div>
            <span class="system-name">智能安全管理系统</span>
          </div>
          <div class="header-right">
            <!-- 下拉菜单 -->
            <el-dropdown @command="handleCommand" trigger="click">
              <span class="user-info" @click.stop>
                <el-avatar :size="32" />
                <span class="username">{{ currentUser.username }}</span>
                <el-tag :type="currentUser.role === 'admin' ? 'primary' : 'success'" size="small">{{ currentUser.role }}</el-tag>
                <el-icon class="el-icon--right"><ArrowDown /></el-icon>
              </span>
              <template #dropdown>
                <el-dropdown-menu>
                  <el-dropdown-item command="profile">
                    <el-icon><User /></el-icon>个人中心
                  </el-dropdown-item>
                  <el-dropdown-item command="settings">
                    <el-icon><Setting /></el-icon>系统设置
                  </el-dropdown-item>
                  <el-dropdown-item divided command="logout" @click="handleLogout">
                    <el-icon><SwitchButton /></el-icon>退出登录
                  </el-dropdown-item>
                </el-dropdown-menu>
              </template>
            </el-dropdown>
          </div>
        </el-header>

        <el-container>
          <!-- 侧边栏菜单 -->
          <el-aside width="220px" class="sidebar">
            <div class="sidebar-header">
              <h3>功能菜单</h3>
            </div>
            <el-menu
              :default-active="activeMenu"
              router
              class="sidebar-menu"
              background-color="#304156"
              text-color="#bfcbd9"
              active-text-color="#ffffff"
            >
              <el-menu-item
                v-for="menu in menuItems"
                :key="menu.id"
                :index="menu.path"
              >
                <el-icon :class="menu.icon"></el-icon>
                <span slot="title">{{ menu.name }}</span>
              </el-menu-item>
            </el-menu>
          </el-aside>

          <el-main class="content">
            <router-view></router-view>
          </el-main>
        </el-container>
      </div>
    </el-container>

    <!-- 个人中心对话框 -->
    <el-dialog v-model="showUserProfile" title="个人中心" width="500px">
      <el-form :model="userProfileForm" :rules="profileRules" ref="profileFormRef" class="login-form">
        <!-- 头像上传区域 -->
        <el-form-item label="用户头像">
          <el-upload
            class="avatar-uploader"
            action="#"
            :show-file-list="false"
            :on-change="handleAvatarUpload"
            :before-upload="beforeAvatarUpload"
            accept="image/*"
          >
            <img v-if="userProfileForm.avatarUrl" :src="userProfileForm.avatarUrl" class="avatar" alt="用户头像" />
            <el-icon v-else class="avatar-uploader-icon"><Plus /></el-icon>
          </el-upload>
        </el-form-item>

        <el-form-item label="用户名" disabled>
          <el-input v-model="userProfileForm.username" placeholder="用户名" />
        </el-form-item>

        <el-form-item prop="name" label="姓名">
          <el-input v-model="userProfileForm.name" placeholder="请输入姓名" />
        </el-form-item>

        <el-form-item prop="email" label="邮箱">
          <el-input v-model="userProfileForm.email" placeholder="请输入邮箱" type="email" />
        </el-form-item>

        <el-form-item label="最后登录时间" class="profile-form-item">
          <el-input
            v-model="lastLoginTime"
            disabled
            placeholder="暂无登录记录"
          ></el-input>
        </el-form-item>

        <el-divider content-position="left">修改密码</el-divider>

        <el-form-item prop="oldPassword" label="原密码">
          <el-input
            v-model="userProfileForm.oldPassword"
            placeholder="请输入原密码"
            type="password"
            prefix-icon="Lock"
            show-password
          >
            <template #prefix>
              <el-icon><Lock /></el-icon>
            </template>
          </el-input>
        </el-form-item>

        <el-form-item prop="newPassword" label="新密码">
          <el-input
            v-model="userProfileForm.newPassword"
            placeholder="请输入新密码"
            type="password"
            prefix-icon="Lock"
            show-password
          >
            <template #prefix>
              <el-icon><Lock /></el-icon>
            </template>
          </el-input>
        </el-form-item>

        <el-form-item>
          <el-button
            type="primary"
            @click="saveUserProfile"
            style="margin-right: 10px;"
          >
            保存资料
          </el-button>
          <el-button
            type="success"
            @click="updatePassword"
          >
            修改密码
          </el-button>
        </el-form-item>
      </el-form>
    </el-dialog>

    <!-- 系统设置对话框 -->
    <el-dialog v-model="showSystemSettings" title="系统设置" width="500px">
      <el-form :model="systemSettingsForm" class="login-form">
        <el-form-item label="主题设置">
          <el-radio-group v-model="systemSettingsForm.theme">
            <el-radio label="light">浅色主题</el-radio>
            <el-radio label="dark">深色主题</el-radio>
          </el-radio-group>
        </el-form-item>

        <el-form-item label="语言设置">
          <el-select v-model="systemSettingsForm.language" placeholder="选择语言">
            <el-option label="简体中文" value="zh-CN"></el-option>
            <el-option label="English" value="en-US"></el-option>
          </el-select>
        </el-form-item>

        <el-form-item label="登录设置">
          <el-switch
            v-model="systemSettingsForm.autoLogin"
            active-text="记住登录状态"
            inactive-text="不记住"
          />
        </el-form-item>

        <el-form-item label="通知设置">
          <el-switch v-model="systemSettingsForm.notification" active-text="开启" inactive-text="关闭" />
        </el-form-item>

        <el-form-item>
          <el-button
            type="warning"
            @click="clearCache"
            style="margin-right: 10px;"
          >
            清除缓存
          </el-button>
          <el-button
            type="primary"
            @click="saveSystemSettings"
          >
            保存设置
          </el-button>
        </el-form-item>
      </el-form>
    </el-dialog>
  </div>

  <!-- 仪表盘模板 -->
<template id="dashboard-template">
  <div class="dashboard-container">
    <!-- 用户信息卡片 -->
    <div class="dashboard-card user-info-card">
      <img :src="currentUser.avatar" class="user-avatar" alt="用户头像">
      <div class="user-details">
        <h3>{{ currentUser.name || currentUser.username || '未知用户' }}</h3>
        <p>邮箱：{{ currentUser.email || '未设置' }}</p>
        <p>角色：{{ currentUser.role || '普通用户' }}</p>
        <p>最后登录：{{ lastLoginTime || '未知' }}</p>
      </div>
    </div>
    <!-- 系统统计卡片 -->
    <div class="dashboard-card stats-card">
      <h3>系统统计</h3>
      <div class="stats-grid">
        <div class="stat-item">
          <span class="stat-label">加密次数</span>
          <span class="stat-value">{{ encryptCount || 0 }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">解密次数</span>
          <span class="stat-value">{{ decryptCount || 0 }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">聊天会话</span>
        </div>
      </div>
    </div>
  </div>
</template>
<!-- 加密模板 -->
<template id="encrypt-template">
  <div class="encrypt-container">
    <div class="encrypt-section">
      <h3>数据加密</h3>
      <el-form ref="encryptFormRef" :model="encryptForm" label-width="80px">
        <el-form-item label="明文">
          <el-input
            type="textarea"
            v-model="encryptForm.plainText"
            rows="5"
            placeholder="请输入需要加密的内容"
            style="resize: vertical;"
          ></el-input>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="encryptData">加密</el-button>
          <el-button type="default" @click="encryptForm.plainText = ''; encryptForm.encryptedText = ''">清空</el-button>
        </el-form-item>
        <el-form-item label="密文">
          <el-input
            type="textarea"
            v-model="encryptForm.encryptedText"
            rows="5"
            readonly
            class="encrypted-text"
          ></el-input>
          <el-button
            v-if="encryptForm.encryptedText"
            type="text"
            @click="copyEncryptedText"
            style="margin-top: 10px;"
          >
            复制密文
          </el-button>
        </el-form-item>
      </el-form>
    </div>

    <!-- 新增解密功能区域 -->
    <div class="decrypt-section">
      <h3>数据解密</h3>
      <el-form ref="decryptFormRef" :model="decryptForm" label-width="80px">
        <el-form-item label="密文">
          <el-input
            type="textarea"
            v-model="decryptForm.encryptedText"
            rows="5"
            placeholder="请输入需要解密的内容"
          ></el-input>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="decryptData">解密</el-button>
          <el-button type="default" @click="decryptForm.encryptedText = ''; decryptForm.decryptedText = ''">清空</el-button>
        </el-form-item>
        <el-form-item label="明文">
          <el-input
            type="textarea"
            v-model="decryptForm.decryptedText"
            rows="5"
            readonly
          ></el-input>
          <el-button
            v-if="decryptForm.decryptedText"
            type="text"
            @click="copyDecryptedText"
            style="margin-top: 10px;"
          >
            复制明文
          </el-button>
        </el-form-item>
      </el-form>
    </div>
  </div>
</template>

  <!-- 解密模板 -->
  <template id="decrypt-template">
    <div class="encrypt-container">
      <div class="encrypt-section">
        <h3>数据解密</h3>
        <el-form ref="decryptForm" :model="decryptForm" label-width="80px">
          <el-form-item label="密文">
            <el-input
              type="textarea"
              v-model="decryptForm.encryptedText"
              rows="5"
              placeholder="请输入需要解密的内容"
            ></el-input>
          </el-form-item>
          <el-form-item>
            <el-button type="primary" @click="decryptData">解密</el-button>
          </el-form-item>
          <el-form-item label="明文">
            <el-input
              type="textarea"
              v-model="decryptForm.decryptedText"
              rows="5"
              readonly
            ></el-input>
          </el-form-item>
        </el-form>
      </div>
    </div>
  </template>

  <!-- 权限模板 -->
  <template id="permissions-template">
    <div class="permissions-container">
      <div class="permission-section">
        <h3>权限分配</h3>
        <el-form
          :model="permissionForm"
          label-width="120px"
          v-if="hasPermission('permissions', 'assign')"
        >
          <el-form-item label="用户名">
            <el-input v-model="permissionForm.username" placeholder="请输入用户名"></el-input>
          </el-form-item>
          <el-form-item label="资源">
            <el-select v-model="permissionForm.resource" placeholder="请选择资源">
              <el-option label="dashboard" value="dashboard"></el-option>
              <el-option label="encrypt" value="encrypt"></el-option>
              <el-option label="decrypt" value="decrypt"></el-option>
              <el-option label="chat" value="chat"></el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="操作">
            <el-select v-model="permissionForm.action" placeholder="请选择操作">
              <el-option label="read" value="read"></el-option>
              <el-option label="write" value="write"></el-option>
              <el-option label="manage" value="manage"></el-option>
            </el-select>
          </el-form-item>
          <el-form-item>
            <el-button type="primary" @click="assignPermission">分配权限</el-button>
          </el-form-item>
        </el-form>
        <el-alert
          v-else
          title="无权限访问"
          type="warning"
          show-icon
        ></el-alert>
      </div>
    </div>
  </template>

 <!-- 聊天模板 -->
<template id="chat-template">
  <div class="chat-container">
    <!-- 左侧会话列表 -->
    <div class="chat-sidebar" :class="{ 'collapsed': !showChatSidebar }">
      <div class="chat-sidebar-header">
        <h3>智能聊天</h3>
      </div>
      <div class="chat-sessions" v-if="showChatSidebar">
        <div
          v-for="session in chatSessions"
          :key="session.id"
          class="chat-session-item"
          :class="{ active: currentSessionId === session.id }"
          @click="currentSessionId = session.id; loadMessages(session.id)"
        >
          <div class="session-title">
            <el-icon><Message /></el-icon>
            {{ session.title || '新对话' }}
          </div>
          <div class="session-actions">
            <el-button
              icon="Edit"
              size="mini"
              type="text"
              @click.stop="editSessionTitle(session.id)"
              title="编辑标题"
            ></el-button>
            <el-button
              icon="Delete"
              size="mini"
              type="text"
              @click.stop="deleteSession(session.id)"
              title="删除对话"
            ></el-button>
          </div>
        </div>
      </div>
    </div>

    <!-- 右侧聊天区域 -->
    <div class="chat-main">
      <div class="chat-header">
        <div class="session-info">
          <el-icon><Message /></el-icon>
          <span v-if="currentSessionId">{{ sessionTitles[currentSessionId] || '新对话' }}</span>
          <span v-else>智能聊天</span>
        </div>
        <div class="header-actions">
          <el-button
            size="small"
            @click="toggleChatSidebar"
            :title="showChatSidebar ? '折叠侧边栏' : '展开侧边栏'"
            class="toggle-sidebar-btn"
          >
            <el-icon>
              <ArrowLeft v-if="showChatSidebar" />
              <ArrowRight v-else />
            </el-icon>
            <span>{{ showChatSidebar ? '折叠' : '展开' }}</span>
          </el-button>
          <el-button
            v-if="currentSessionId"
            icon="Edit"
            size="small"
            @click="editSessionTitle(currentSessionId)"
            type="text"
            title="编辑标题"
          ></el-button>
          <el-button
            v-if="currentSessionId"
            icon="Delete"
            size="small"
            @click="deleteSession(currentSessionId)"
            type="text"
            title="删除对话"
          ></el-button>
          <el-button
            icon="Plus"
            size="small"
            @click="createNewSession"
            type="text"
            title="开始新对话"
          ></el-button>
        </div>
      </div>

      <!-- 消息列表 -->
      <div class="chat-messages" id="chat-messages-container">
        <!-- 无会话时显示 -->
        <div v-if="!currentSessionId" class="empty-chat">
          <el-empty description="请选择或创建一个对话"></el-empty>
          <div class="chat-default-hints">
            <p class="hint-title">💡 智能聊天功能可以帮您：</p>
            <ul class="hint-list">
              <li>解答加密/解密相关问题</li>
              <li>查询权限配置指南</li>
              <li>获取系统操作帮助</li>
              <li>生成安全策略建议</li>
            </ul>
            <el-button
              type="primary"
              size="medium"
              @click="createNewSession"
              class="start-chat-btn"
            >
              <el-icon><Message /></el-icon> 开始新对话
            </el-button>
          </div>
        </div>

        <!-- 有会话时显示消息列表 -->
        <div v-else>
          <div class="load-more-container" v-if="hasMoreMessages">
            <el-button
              @click="loadMoreMessages"
              size="small"
              class="load-more-btn"
              :loading="loadingMore"
            >
              加载更多消息
            </el-button>
          </div>

          <div
            v-for="msg in messages"
            :key="msg.id"
            class="message"
            :class="msg.role"
          >
            <img
              :src="msg.role === 'user' ? currentUser.avatar || '/static/default-avatar.png' : '/static/ai-avatar.png'"
              class="message-avatar"
              alt="Avatar"
            >
            <div class="message-content">
              <div class="message-text">{{ msg.content }}</div>
              <div class="message-time">
                {{ new Date(msg.created_at).toLocaleString() }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 输入区域 -->
      <div class="chat-input-area" v-if="currentSessionId">
        <div class="chat-input-container">
          <el-input
            v-model="newMessage"
            class="chat-input"
            placeholder="输入消息..."
            @keyup.enter="sendMessage"
            type="textarea"
            :rows="3"
            resize="none"
            :disabled="isSending"
          ></el-input>
          <el-button
            type="primary"
            @click="sendMessage"
            :loading="isSending"
            :disabled="!newMessage.trim()"
          >
            发送
          </el-button>
        </div>
      </div>
    </div>
  </div>
</template>
</body>
</html>